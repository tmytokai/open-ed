<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
<link rel="stylesheet" href="../../../common.css">
<script src="../../../common.js"></script>
<title>演習</title>
</head>
<body>

<nav class="brcr">
<ol>
<li><a href="../">アクティビティ: 入出力インターフェース</a></li>
<li>学習項目: [4] PWM</li>
<li><script>GetTitle()</script></li>
</ol>
</nav>

<h2><script>GetTitle()</script></h2>

<p>
演習時間: 30  分
</p>

<br>
<h2><a href="./page01.html">1. PWM とは</a></h2>
<h2><a href="./page02.html">2. 出力</a></h2>

<p>
<input type="checkbox"><b>演習 4-1 (個人PC、30分):</b> PWM を使ってみましょう。プログラムの仕様は以下の通りです。
</p>
<div class="info">
<p>
<b>仕様:</b>
</p>
<p>
1827は CCP(Capture/Compare/PWM)モジュールを4つ(CCP1、CCP2、CCP3、CCP4) 積んでいます
<br>
またタイマーモジュールを3つ(Timer2、Timer4、Timer6) 積んでるので同時に 3 つ PWM 出力可能です
<br>
なお CCP1 と CCP2 は設定で出力ピンの位置を変更できます
</p>
<ol>
<li>CCP1 を使用する</li>
<li>CCP1 の出力ピンは 9 pin とする</li>
<li>CCP1 に接続するタイマーとして Timer2 を使う</li>
<li> Timer2 の prescale は x64 とする</li>
<li>スイッチを離している時は PWM周期 16 ミリ秒、パルス幅 8 ミリ秒</li>
<li>スイッチを押している時は PWM周期 8 ミリ秒、パルス幅 6 ミリ秒</li>
</ol>

</div>
<div class="olradio">
<p>
<span class="olradio"><input type="radio" name="p1"></span> プロジェクト「IO_3_1」を「IO_4_1」にコピーします。
<br>
<span class="olradio"><input type="radio" name="p1"></span> プロジェクト IO_3_1 を閉じます。
<br>
<span class="olradio"><input type="radio" name="p1"></span> (もし開きっぱなしになっていたら) 前のプロジェクトで開いていたソースを全て閉じます。
<br>
<span class="olradio"><input type="radio" name="p1"></span> (IDEのバージョンによっては) プロジェクトのプロパティを開き、そのまま「Apply」ボタンを押して設定ファイルを更新します。※ 通常は自動で設定ファイルが更新されますが、バージョンによってはバグのため自動更新されないようです
<br>
<span class="olradio"><input type="radio" name="p1"></span> setting.h を開き、「//#define #define USE_CCP1」のコメントアウトを解除します。 
<br>
<span class="olradio"><input type="radio" name="p1"></span> ccp.c を開きます。
<br>
<span class="olradio"><input type="radio" name="p1"></span> CCP1 を使うので、CCP1の初期化関数( void init_ccp1() )を見ます。
<br>
<span class="olradio"><input type="radio" name="p1"></span> main.c を開き、ファイルの中身を<a href="./src/IO_4_1.txt">テンプレート</a>の内容に置き換えて下さい。
<br>
<span class="olradio"><input type="radio" name="p1"></span> 穴埋め問題になっていますので？のところを正しい内容に修正してください)
</p>
<p>
この演習で気をつける必要がある設定は以下の通りです。
</p>
<div class="info">
<pre class="wrap">
<b>ccp.c の void init_ccp1() 内</b>

<b>設定 1:</b>

APFCON0bits.CCP1SEL ※ 8bit レジスタ APFCON0 の bit 0

(解説)

0 をセットするとRB3(9 pin) を CCP1 の出力とします
1 をセットするとRB0(6 pin) を CCP1 の出力とします
詳しくはデータシート 118p を参照してください


<b>設定 2:</b>

CCP1CONbits.CCP1M ※ 8bit レジスタ CCP1CON の bit 3〜0

(解説)

動作モードを設定します
0b1100 をセットすると PWM 出力モードになります
詳しくはデータシート 204p を参照してください


<b>設定 3:</b>

CCPTMRSbits.C1TSEL ※ 8bit レジスタ CCPTMRS の bit 1〜0

(解説)

タイマーを接続します
0b00 = Timer2、0b01 = Timer4、0b10 = Timer6
詳しくはデータシート 206p を参照してください
   

<b>設定 4:</b>

T?CONbits.T?CKPS ※ ? は接続したタイマーの番号(2, 4, 6 のどれか)

(解説)

タイマーの prescale を設定します
0b00 = x1、0b01 = x4、0b10 = x16、0b11 = x64
PWM 周期やパルス幅の計算で使います
詳しくはデータシート 191p を参照してください


<b>設定 5:</b>

T?CONbits.TMR?ON ※ ? は接続したタイマーの番号(2, 4, 6 のどれか)

(解説)

1 をセットするとタイマーが ON になり PWM 出力が始まります
詳しくはデータシート 191p を参照してください


<b>PWM周期、パルス幅の計算方法</b>

今回は CCP1 + Timer2 の組み合わせなので 
PWM 周期と パルス 幅は FOSC、prescale、PR2、CCPR1L、DC1B1、DC1B0 を使って以下のように決まります

PR2 は Timer2 の設定用の 8bit レジスタです
CCPR1L は CCP1 の設定用の 8bit レジスタです
DC1B1、DC1B0 は CCP1 の設定用の 8bit レジスタ CCP1CON の bit 5〜4 です
詳しい計算式は 212p を参照して下さい

TOSC = 1/FOSC
PWM 周期 = TOSC * (4* prescale) * (PR2+1) 秒
パルス幅 = TOSC * prescale * (CCPR1L:DC1B1:DC1B0) 秒
</pre>
</div>
<p>
<span class="olradio"><input type="radio" name="p1"></span> 回路を作成します。
</p>
<p>
以下の設定に従って回路を作成して下さい。
<br>
(*) が前の演習からの変更箇所です。
</p>
<div class="info">
<pre class="wrap">
<b>ピン配置設定・回路接続方法:</b>

PIC

1: RA2
2: RA3
3: RA4
4: MCLR/VPP -- PICkit の 1: NMCLR ※ PIC内部で弱プルアップしてるのでプルアップ抵抗必要無
5: VSS -- GND -- PICkit の 3: GND
6: RB0 (入力) -- スイッチ -- GND ※ PIC内部で弱プルアップしてるのでプルアップ抵抗必要無 
7: RB1
8: Rx (UART) -- ADM3202 の 12: R1OUT -- ADM3202 の 13: R1IN -- RS-232C の Tx(白)
(*)9: CCP1 (PWM) -- オシロスコープ

10: RB4
11: Tx (UART) -- ADM3202 の 11: T1IN -- ADM3202 の 14: T1OUT -- RS-232C の Rx (黄)
12: ICSPCLK -- PICkit の 5: PGC
13: ICSPDAT -- PICkit の 4: PGD
14: VDD -- 3.3V -- PICkit の 2: VDD
15: RA6
16: RA7
17: RA0 (出力) -- LED -- 抵抗(330Ω)  -- GND
18: AN1 (ADC) -- 可変抵抗の真中ピン -- GND


可変抵抗(上記以外のピン)

左側ピン: 3.3V
右側ピン: GND
</pre>
</div>
<p>
<span class="olradio"><input type="radio" name="p1"></span> 書き込みボタンを押して正常に動作する事を確認して下さい。 
<br>
<span class="olradio"><input type="radio" name="p1"></span> 指定場所に「ccp.c」と「main.c」を記入してください。
</p>

</div>

<br>
<p>
<input type="checkbox"><b>演習 4-2 (個人PC、30分):</b> PWM を使って音を鳴らしてみましょう。プログラムの仕様は以下の通りです。
</p>
<div class="info">
<p>
<b>仕様:</b>
</p>
<ol>
<li>CCP4 を使用する</li>
<li>CCP4 の出力ピンは 3 pin とする(固定)</li>
<li>CCP4 に接続するタイマーとして Timer4 を使う</li>
<li>Timer4 の prescale は x64 とする</li>
<li>スイッチを離している時はオクターブ3のド(131 Hz) の音を出す</li>
<li>スイッチを押している特はオクターブ3のソ(196 Hz) の音を出す</li>
</ol>

</div>
<div class="olradio">
<p>
<span class="olradio"><input type="radio" name="p2"></span> プロジェクト「IO_4_1」を「IO_4_2」にコピーします。
<br>
<span class="olradio"><input type="radio" name="p2"></span> プロジェクト IO_4_1 を閉じます。
<br>
<span class="olradio"><input type="radio" name="p2"></span> (もし開きっぱなしになっていたら) 前のプロジェクトで開いていたソースを全て閉じます。
<br>
<span class="olradio"><input type="radio" name="p2"></span> (IDEのバージョンによっては) プロジェクトのプロパティを開き、そのまま「Apply」ボタンを押して設定ファイルを更新します。※ 通常は自動で設定ファイルが更新されますが、バージョンによってはバグのため自動更新されないようです
<br>
<span class="olradio"><input type="radio" name="p2"></span> setting.h を開き、「//#define #define USE_CCP4」のコメントアウトを解除します。
<br>
<span class="olradio"><input type="radio" name="p2"></span> ccp.c を開きます。
<br>
<span class="olradio"><input type="radio" name="p2"></span> CCP4 を使うので、CCP4の初期化関数( void init_ccp4() )を見ます。
<br>
<span class="olradio"><input type="radio" name="p2"></span> main.c を開き、ファイルの中身を<a href="./src/IO_4_2.txt">テンプレート</a>の内容に置き換えて下さい。
<br>
<span class="olradio"><input type="radio" name="p2"></span> 穴埋め問題になっていますので？のところを正しい内容に修正してください。
</p>
<p>
この演習で気をつける必要がある設定は以下の通りです。
</p>
<div class="info">
<pre class="wrap">
<b>レジスタ設定</b>

演習4-1で CCP1 を CCP4、Timer2 を Timer4 に読み替えるだけで同様にして設定できます。
ただし CCP4 の出力は RA4(3 pin) 固定です 


<b>PWM周期、パルス幅の計算方法</b>

こちらも演習4-1で CCP1 を CCP4、Timer2 を Timer4 に読み替えるだけで同様にして計算できます。


<b>音階とPWM周期、パルス幅の関係:</b>

・オクターブ3のド(131 Hz)

131 Hzは周期で言うと 1/131 = 0.0076 秒 = 7.6 ミリ秒なので、PWM 周期を 7.6 ミリ秒にします。
パルス幅は(適当に決めて良いけど)今回は PWM 周期の半分の 3.8 ミリ秒にします。

・オクターブ3のソ(196 Hz)

196 Hzは周期で言うと 1/196 = 0.0051 秒 = 5.1 ミリ秒なので、PWM 周期を 5.1 ミリ秒にします。
パルス幅は(適当に決めて良いけど)今回は PWM 周期の半分の 2.6 ミリ秒にします。
</pre>
</div>
<p>
<span class="olradio"><input type="radio" name="p2"></span> 回路を作成します。
</p>
<p>
以下の設定に従って回路を作成して下さい。
<br>
(*) が前の演習からの変更箇所です。
</p>
<div class="info">
<pre class="wrap">
<b>ピン配置設定・回路接続方法:</b>

PIC

1: RA2
2: RA3
(*)3: CCP4 (PWM) -- 圧電スピーカ -- GND
4: MCLR/VPP -- PICkit の 1: NMCLR ※ PIC内部で弱プルアップしてるのでプルアップ抵抗必要無
5: VSS -- GND -- PICkit の 3: GND
6: RB0 (入力) -- スイッチ -- GND ※ PIC内部で弱プルアップしてるのでプルアップ抵抗必要無 
7: RB1
8: Rx (UART) -- ADM3202 の 12: R1OUT -- ADM3202 の 13: R1IN -- RS-232C の Tx(白)
9: CCP1 (PWM) -- オシロスコープ

10: RB4
11: Tx (UART) -- ADM3202 の 11: T1IN -- ADM3202 の 14: T1OUT -- RS-232C の Rx (黄)
12: ICSPCLK -- PICkit の 5: PGC
13: ICSPDAT -- PICkit の 4: PGD
14: VDD -- 3.3V -- PICkit の 2: VDD
15: RA6
16: RA7
17: RA0 (出力) -- LED -- 抵抗(330Ω)  -- GND
18: AN1 (ADC) -- 可変抵抗の真中ピン -- GND


可変抵抗(上記以外のピン)

左側ピン: 3.3V
右側ピン: GND
</pre>
</div>
<p>
<span class="olradio"><input type="radio" name="p2"></span> 書き込みボタンを押して正常に動作する事を確認して下さい。 
<br>
<span class="olradio"><input type="radio" name="p2"></span> 指定場所に「ccp.c」と「main.c」を記入してください。
</p>

</div>


<script>PreNext(3,2)</script>
</body>
</html>
