<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
<link rel="stylesheet" href="../../../common.css">
<script src="../../../common.js"></script>
<title>演習</title>
</head>
<body>

<nav class="brcr">
<ol>
<li><a href="../">アクティビティ: 入出力インターフェース</a></li>
<li>学習項目: [7] I2C</li>
<li><script>GetTitle()</script></li>
</ol>
</nav>

<h2><script>GetTitle()</script></h2>

<p>
演習時間: 70  分
</p>

<br>
<h2><a href="./page01.html">1. I2C とは</a></h2>

<br>
<p>
<input type="checkbox"><b>演習 6-1 (個人PC、70分):</b> Arduino UNO で I2C 経由で加速度センサからデータを受け取りましょう。
</p>
<div class="olradio">
<p>
<span class="olradio"><input type="radio" name="p1"></span>仕様は以下の通りです。
</p>
<div class="info">
<b>仕様:</b>
<p>
(センサ側)
</p>
<p>
(1) 「３軸加速度センサモジュール　ＡＤＸＬ３４５」を I2C 経由で使用する。
</p>
<p>
(2) 3.3V 駆動とする。 
</p>
<p>
　※ 本来は電圧レベル変換モジュールを挟まないと壊れますが、今回は短時間なので Arduino の3.3V出力へ直に接続します。
</p>
<p>
(3) デバイスのアドレスは「0x53」とする ( SDO/ALT ADRESS ピン = 12 ピンを接地する)。
</p>

<p>
(Arduino側)
</p>
<p>
(4) I2Cの設定で、サンプリングモードを「+-2G を 10bit(+512 〜 -512) で検出」にする。
</p>
<p>
(5) Arduino 側の ピンは SDA = A4、SCL = A5 である。
</p>
<p>
(6) 500ミリ秒間隔でサンプリングし、シリアルモニタ(虫めがねボタン)に結果を表示する。
</p>
<p>
(7) 結果の加速度は double 型の数値とし、「[x方向の加速度, y方向の加速度, z方向の加速度],」の形式で画面に出力する(桁数は自由)
</p>
<p>
(出力例) [0.0123, -1.0004, 0.0212],
</p>
</div>
<p>
<span class="olradio"><input type="radio" name="p1"></span>データシート等を見ながら回路を組んで下さい。
<br>
<span class="olradio"><input type="radio" name="p1"></span>回路を組んだらファシリテータの確認を受けて下さい。
<br>
<span class="olradio"><input type="radio" name="p1"></span>プログラムを書いて Arduino UNO に転送して下さい。
今回のプログラム内で利用するＡＤＸＬ３４５のレジスタは以下の8つだけです(その他のレジスタはデータシートの25ページ目を参照して下さい)。
</p>
<table>
<tr><th>レジスタ名</th><th>アドレス</th><th>サイズ</th><th>説明</th></tr>

<tr>
<td class="center">POWER_CTL</td>
<td class="center">0x2D</td>
<td class="center">8 bit</td>
<td>(読み書き可) 動作モード切り替え</td>
</tr>

<tr>
<td class="center">DATA_FORMAT</td>
<td class="center">0x31</td>
<td class="center">8 bit</td>
<td>(読み書き可) 各軸の出力データの形式を設定する</td>
</tr>

<tr>
<td class="center">DATAX0</td>
<td class="center">0x32</td>
<td class="center">8 bit</td>
<td>(読み出し専用) X軸の出力データの最下位バイト</td>
</tr>

<tr>
<td class="center">DATAX1</td>
<td class="center">0x33</td>
<td class="center">8 bit</td>
<td>(読み出し専用) X軸の出力データの最上位バイト</td>
</tr>

<tr>
<td class="center">DATAY0</td>
<td class="center">0x34</td>
<td class="center">8 bit</td>
<td>(読み出し専用) Y軸の出力データの最下位バイト</td>
</tr>

<tr>
<td class="center">DATAY1</td>
<td class="center">0x35</td>
<td class="center">8 bit</td>
<td>(読み出し専用) Y軸の出力データの最上位バイト</td>
</tr>

<tr>
<td class="center">DATAZ0</td>
<td class="center">0x36</td>
<td class="center">8 bit</td>
<td>(読み出し専用) Z軸の出力データの最下位バイト</td>
</tr>

<tr>
<td class="center">DATAZ1</td>
<td class="center">0x37</td>
<td class="center">8 bit</td>
<td>(読み出し専用) Z軸の出力データの最上位バイト</td>
</tr>

</table>


<p>
(ＡＤＸＬ３４５のレジスタに値を書き込む方法)
</p>
<pre>
Wire.beginTransmission( 0x53 ); // 0x53 はデバイスのアドレス
Wire.write( 値を書き込むレジスタのアドレス ); 
Wire.write( レジスタに書き込む値 );   
Wire.endTransmission();
</pre>

<p>
(ＡＤＸＬ３４５の複数のレジスタから値を一度で読み込む方法)
</p>
<pre>
byte data[読み込むバイト数];

Wire.beginTransmission(0x53); // 0x53 はデバイスのアドレス
Wire.write( 値の読み込みを開始するレジスタのアドレス ); 
Wire.endTransmission(); 
     
Wire.requestFrom( 0x53, 読み込むバイト数 ); 

for( int i=0; i < 読み込むバイト数; ++i){ 
  if( Wire.available() > 0 ){
    data[i] = Wire.read(); 
  }
}
</pre>

<p>
※1 setup の中で DATA_FORMAT レジスタに 0x00 を書き込むとサンプリングモードが「+-2G を 10bit(+512 〜 -512) で検出)」になります(詳細はデータシートの28P目参照)。
</p>
<p>
※2 それ以外のレジスタ値はデフォルトのままにします。
</p>
<p>
※3 setup の中で POWER_CTL レジスタに「0x08」を書き込むと測定を開始します(詳細はデータシートの27P目参照)。
</p>
<p>
※4 loopの中でＡＤＸＬ３４５の DATAxx レジスタ(0x32〜0x37)の値を読み込む時は<b>「char 型ではなくて byte 型の配列を使用して下さい」</b>(そうしないと正しい値が取得できない)。
</p>
<p>
※5 loopの中でサンプリング値を加速度に変換してから虫眼鏡に表示して下さい。サンプリング値が -512 の時は -2G、+512 の時は +2G です。
</p>
<p>
<span class="olradio"><input type="radio" name="p1"></span>動作確認して下さい。
</p>
<p>
※1 加速度の検出方向はデータシートのP34に書いてあります。
<br>
※2 <b>次回の演習でプログラムを再利用するので、画面出力が仕様の(7)に沿っていることを確認して下さい</b>
</p>
<p>
<span class="olradio"><input type="radio" name="p1"></span>動作したらファシリテータの確認を受けて下さい。
<br>
<span class="olradio"><input type="radio" name="p1"></span>ソースコードをドキュメントにコピーして下さい。
</p>
</div>

<script>PreNext(4,3)</script>
</body>
</html>
