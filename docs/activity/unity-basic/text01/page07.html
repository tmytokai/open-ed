<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
<link rel="stylesheet" href="../../../common.css">
<script src="../../../common.js"></script>
<title>7. 衝突時の処理</title>
</head>
<body>

<nav class="brcr">
<ol>
<li><a href="../">アクティビティ: Unity 入門</a></li>
<li>学習項目: [1] Unity の基本(2D編)</li>
<li><script>GetTitle()</script></li>
</ol>
</nav>

<h2><script>GetTitle()</script></h2>

<p>
ここではゲームオブジェクトとゲームオブジェクトが衝突した時の処理を取り上げます。
<br>
初心者にとっては複雑な仕組みなので順を追って説明していきます。
</p>

<br>
<h3>
(1) OnCollision〜系による衝突判定
</h3>

<p>
オブジェクト同士がぶつかった時の衝突判定方法は主に OnCollision〜系、OnTrigger〜系に分かれます。
</p>

<p>
ここでは基本的な衝突判定処理である OnCollision〜系、特に <b>OnCollisionEnter2D</b> について説明します。
<br>
OnCollisionEnter2D はゲームオブジェクト同士が衝突した瞬間に呼び出されるメソッドです。
</p>

<p>
さて A と B というゲームオブジェクトがあってそれらの衝突判定処理をおこなうことにします。
<br>
その場合、まずは次の様にして A と B に〜Collider 2D コンポーネントをアタッチします。
</p>

<div class="info">
<input type="checkbox"><b>〜Collider 2D コンポーネントをアタッチする</b>
<div class="olradio"> 
<p>
<span class="olradio"><input type="radio" name="p1"></span> Hierarchy ウィンドウで対象のオブジェクトを選択する。 
<br>
<span class="olradio"><input type="radio" name="p1"></span> Inspector ウィンドウの Add Component ボタンを押してメニューを表示する。 
<br>
<span class="olradio"><input type="radio" name="p1"></span> Physics 2D → 〜Collider 2D を選択する。
</p>
<p>
※ 〜Collider には Box(四角形の判定領域)、Circle(円状の判定領域) など色々あります。
</p>
<p>
<span class="olradio"><input type="radio" name="p1"></span> Inspector ウィンドウの 〜Collider 2D の所にある Edit Collider ボタンを押すと衝突判定領域の調整が出来る。
</p>
</div>
</div>

<p>
するとこの時点でゲームオブジェクト A、B 間に衝突が生じて重なる事が出来なくなります。
</p>

<p>
後は A 又は B どちらかのスクリプトに対して以下の  OnCollisionEnter2D メソッドを追加するだけで衝突判定が出来ます。
</p>

<div class="info">
<input type="checkbox"><b>OnCollisionEnter2D : ゲームオブジェクト同士が衝突した瞬間に呼び出される</b>
<pre class="wrap">
void OnCollisionEnter2D( Collision2D collision )
{
     // 衝突判定処理
}
</pre>
</div>

<br>
<h3 id="layer">
(2) レイヤーによる衝突設定
</h3>

<p>
3 つの A 、 B 、 C というゲームオブジェクトがあり、A は B とは衝突したいけど C とは衝突したくないという時は<b>レイヤー機能</b>を使います。
</p>

<p>
まず大前提として各ゲームオブジェクトは必ずある階層(レイヤー)に属しています(※)。
<br>
デフォルトでは全てのゲームオブジェクトは Default という名前のレイヤーに属しています。
</p>

<p>
※ 建物の 1F と 2F にオブジェクトがいるみたいなイメージです。
</p>

<p>
従って属するレイヤーを違うものにすればゲームオブジェクト同士が衝突出来ないようにすることが可能です。
<br>
ゲームオブジェクトにレイヤーを設定する手順は以下のとおりです。
</p>

<div class="info">
<input type="checkbox"><b>ゲームオブジェクトにレイヤーを設定する</b>
<div class="olradio"> 
<p>
<span class="olradio"><input type="radio" name="p2"></span> Hierarchy ウィンドウ上でゲームオブジェクトを選択してInspector ウィンドウを開く。デフォルトでは Layer プルダウンメニューに Default と書いてあることを確認する。
<br>
<span class="olradio"><input type="radio" name="p2"></span> (レイヤーを新規作成する場合) Layer プルダウンメニューをクリック → Add Layer を選択し、下の図の様に User Layer の空いている所に好きなレイヤー名を設定する。
</p>
<img src="./img/layer1.png" alt="">
<p>
<span class="olradio"><input type="radio" name="p2"></span>  Layer プルダウンメニューから適切なレイヤーを選択する。
</p>
</div>
</div>

<p>
これでゲームオブジェクトにレイヤーを設定出来ましたが、このままだとまだ全てのオブジェクト間と衝突が起きますので、以下のようにして特定のレイヤーに属するゲームオブジェクト同士は衝突出来ないようにします。
</p>

<div class="info">
<input type="checkbox"><b>レイヤー間の衝突設定をする</b>
<div class="olradio"> 
<p>
<span class="olradio"><input type="radio" name="p3"></span> Unity エディタの Edit メニュー → Project Settings → Physics2D を選択する。
<br>
<span class="olradio"><input type="radio" name="p3"></span> 以下の例のように Layer Collision Matrix の設定をする。チェックが付いているレイヤー間は衝突が起きる。
</p>
<img src="./img/layer2.png" alt="">
<br>
※ 上の例の場合 LayerA と Layer C の所がチェックが外れているので、LayerA に属するゲームオブジェクトと LayerC に属するゲームオブジェクトは衝突しない。
</div>
</div>

<br>
<h3>
(3) タグによる衝突したオブジェクトの判定
</h3>

<p>
OnCollision〜 や OnTrigger〜 の中で衝突したゲームオブジェクトによって処理を変えたい場合は<b>タグ</b>機能を使います。
</p>

<p>
各ゲームオブジェクトはタグを付けて区別する事が出来ます(デフォルトではタグは付いていません)。
<br>
ゲームオブジェクトにタグを設定する手順は以下のとおりです。
</p>

<div class="info">
<input type="checkbox"><b>ゲームオブジェクトにタグを設定する</b>
<div class="olradio"> 
<p>
<span class="olradio"><input type="radio" name="p4"></span> Hierarchy ウィンドウ上でゲームオブジェクトを選択して Inspector ウィンドウを開く。デフォルトでは Tag プルダウンメニューに Untagged と書いてあることを確認する。
<br>
<span class="olradio"><input type="radio" name="p4"></span> (タグを新規作成する場合) Tag プルダウンメニューをクリック → Add Tags を選択し、Tags の + ボタンを押し、下の図の様に好きなタグ名を入れて Save で保存する。
</p>
<img src="./img/tag1.png" alt="">
<p>
<span class="olradio"><input type="radio" name="p4"></span>  Tag プルダウンメニューから適切なタグを選択する。
</p>
</div>
</div>

<p>
こうして設定したタグは衝突時に以下のようにして OnCollisionEnter2D 内で使用できます。
</p>

<div class="info">
<input type="checkbox"><b>OnCollisionEnter2D</b>
<pre class="wrap">
void OnCollisionEnter2D( Collision2D collision )
{
    if (collision.gameObject.tag == "TagA") {	

       // TagA がついたゲームオブジェクトと衝突した時の処理

    }
    if (collision.gameObject.tag == "TagB") {	

       // TagB がついたゲームオブジェクトと衝突した時の処理

    }
    // 以下同様

}
</pre>
</div>

<br>
<h3>
(4) マテリアルによる摩擦と弾性の設定
</h3>

<p>
〜Collider 2D コンポーネントをアタッチしたゲームオブジェクトには<b>マテリアル</b>をセットすることで摩擦と弾性を設定する事が出来ます。
<br>
するとオブジェクト同士に摩擦を生じさせたり、ぶつかった時に跳ね返らせたりすることが可能になります。
</p>

<p>
マテリアルの設定方法は以下の通りです。
</p>

<div class="info">
<input type="checkbox"><b>マテリアルの設定</b>
<div class="olradio"> 
<p>
<span class="olradio"><input type="radio" name="p5"></span> Assets フォルダ上で右クリック → Create → Physics Material 2D を選択して(※) マテリアルアセットを新規作成する。名前は適宜変更する。
</p>
<p>
※ 項目に Physics Material と Physics Material 2D の 2 つありますが、後ろに 2D が付いている方を選択して下さい。
</p>
<p>
<span class="olradio"><input type="radio" name="p5"></span> 新規作成したマテリアルをクリックし、 Inspector ウィンドウの Friction(摩擦) と Bounciness(弾性)を好みの値に変更する。
<br>
<span class="olradio"><input type="radio" name="p5"></span> Hierarchy ウィンドウでマテリアルを設定したいゲームオブジェクトを選択する。
<br>
<span class="olradio"><input type="radio" name="p5"></span> Inspector ウィンドウの 〜Collider 2D の Material にマテリアルを DnD する。
<br>
<span class="olradio"><input type="radio" name="p5"></span> (跳ね返りが弱い場合) Unity エディタの  Edit メニュー → Project Settings → Physics2D の Velocity Threshold の値を小さくする(最小値は 0.0001)。
</p>
</div>
</div>

<br>
<h3>
(5) OnTrigger〜系による衝突判定
</h3>

<p>
今までゲームオブジェクト間は衝突して重なる事が出来ない状況を考えていましたが、レーザー光線みたいに他のゲームオブジェクトと重なっても突き抜ける様なゲームオブジェクトと衝突判定をしたい場合は OnTrigger〜系による衝突判定を行います。
</p>

<p>
今回は特に <b>OnTriggerEnter2D</b> を取り上げます。
<br>
OnTriggerEnter2D はゲームオブジェクト間が重なった瞬間に呼び出されるメソッドです。
</p>

<p>
2 つの A 、 B というゲームオブジェクトがあり、A と B は重なる事が出来て、かつ重なった時に何か処理をしたいという場合、まずは A か B どちらかのゲームオブジェクトに対して<b>トリガー</b>設定をします(※)。
</p>

<p>
※ もちろん上で出てきたレイヤー機能を使っても重なるようにする事が出来ますが重なったという判定が出来ません。
</p>

<div class="info">
<input type="checkbox"><b>トリガー設定の方法</b>
<div class="olradio"> 
<p>
<span class="olradio"><input type="radio" name="p6"></span> Hierarchy ウィンドウで対象のゲームオブジェクトを選択する。 
<br>
<span class="olradio"><input type="radio" name="p6"></span> Inspector ウィンドウの 〜Collider 2D の Is Trigger プロパティをチェックする。
</p>
</div>
</div>

<p>
するとこの時点でトリガー設定をしたゲームオブジェクトは他のゲームオブジェクトと重なることが出来るようになります。
</p>

<p>
ただし、上で取り上げた OnCollisionEnter2D メソッドは呼び出されなくなりますので、代わりに次の OnTriggerEnter2D メソッドを使います。
<br>
もちろんタグを使って重なったゲームオブジェクトの判定も出来ます。
</p>

<div class="info">
<input type="checkbox"><b>OnTriggerEnter2D</b>
<pre class="wrap">
void OnTriggerEnter2D( Collider2D collider ) // OnCollisionEnter2D と引数の型が異なることに注意
{
    if ( collider.tag == "TagA") {	

       // TagA がついたゲームオブジェクトと重なった時の処理

    }
    if ( collider.tag == "TagB") {	

       // TagB がついたゲームオブジェクトと重なった時の処理

    }
    // 以下同様

}
</pre>
</div>

<p>
なおトリガーよりもレイヤーが優先されますので、レイヤーで衝突出来ないように設定している場合はゲームオブジェクトが重なっても OnTriggerEnter2D は呼び出されません。
</p>

<p>
ちなみに少し高度な話になりますが、親オブジェクトに Rigidbody 2D と 〜Collider 2D をアタッチし、子オブジェクトには 〜Collider 2D だけをアタッチした時、子オブジェクトの衝突イベントは親オブジェクトに送られます。
<br>
この仕様を応用すると親は非トリガー設定にしてすり抜け不可、子はトリガー設定ですり抜け可能とすることも可能になるので接地判定などに使えます。
</p>

<br>
<script>PreNext(7,10)</script>
</body>
</html>
