<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<link rel="stylesheet" href="../../../common.css">
<title>値渡しとポインタ渡し</title>
</head>
<body>

<p>
<a href="../">アクティビティ: C言語のポインタ</a>
<br>
学習項目: [6] 活用例(1) 関数へのポインタ渡し
</p>

<h2>値渡しとポインタ渡し</h2>

<p>
ここからはポインタ変数の活用方法についていくつか例を挙げたいと思います。
<br>
まずは関数への引数の「ポインタ渡し」の例について紹介します。
</p>

<br>
<h3>
1. 値渡しとポインタ渡し(と参照渡し)
</h3>

<p>
みなさんが初めて C言語の「関数」について学んだ時、大抵は以下のようなソースコードを書いたと思います。
</p>

<div class="info">
<input type="checkbox"><b> C言語の関数のソース例</b>
<pre class="wrap">
#include &lt;stdio.h&gt;

void HOGE( int a )
{
   printf( "%d\n", a );
}


int main()
{
   int a = 1;

   HOGE( a );

   return 0;
}
</pre>
</div>

<p>
この HOGE 関数は正確には「引数が int 型の a 、戻り値が void 型である HOGE 関数」と呼ばれますが、今回は引数の渡し方のところに注目してみたいと思います。
</p>

<p>
今まではあまり変数を引数として関数に渡す方法について意識して来なかったと思いますが、(C言語以外も含めて)プログラミング言語における引数の渡し方の種類は大きく 3 つに分かれます。
</p>

<div class="info">
<input type="checkbox"><b>引数の渡し方の種類:</b>

<p>
(1) 値渡し
</p>

<p>
(2) ポインタ渡し
</p>

<p>
(3) 参照渡し
</p>

</div>

<p>
ここで (3) の参照渡しは値渡しとポインタ渡しの良い所取りをした性質を持つ引数の渡し方なのですが、C 言語には無い機能ですので今回は説明を省きます。
<br>
ただしC言語よりも新しいプログラミング言語では参照渡しがデフォルト動作となっている事が多いので、後で必ず自学自習しておいて下さい。
</p>

<p>
さて (1) の値渡しはみなさんが今まで学んできた普通の引数の渡し方で、次のように定義します。
</p>

<div class="info">
<input type="checkbox"><b>(1) 「値渡し」による引数の定義:</b>

<p>
引数の型 引数名
</p>

<pre class="wrap">
(例) 

※ int a が引数定義
void HOGE( int a )
{
   printf( "%d\n", a );
}


※ この関数の呼び出し方
HOGE( a );
</pre>

</div>

<p>
(2) はポインタ変数を利用する引数の渡し方で、次のように定義します。
</p>

<div class="info">
<input type="checkbox"><b>(2) 「ポインタ渡し」による引数の定義:</b>

<p>
引数の型 *引数名
</p>

<pre class="wrap">
(例) 

※ int *pa が引数定義
void HOGE( int *pa )
{
  ※ 関数の中で引数を使いたい時は間接演算子 * を付ける
   printf( "%d\n", *pa );
}


※ この関数の呼び出し方
※ アドレス演算子 &amp; を変数の前に付ける
HOGE( &amp;a );
</pre>

</div>

<p>
それぞれの方法にはメリット・デメリットがあり、状況に応じて使い分けられています。
</p>

<div class="info">
<input type="checkbox"><b>各渡し方のメリット・デメリット:</b>

<p>
(1) 値渡し
</p>

<ul>
<li>メリット:　ソースコードがすっきりして見やすい、初学者が理解しやすい</li>
<li>デメリット:　<b>関数の中で呼び出し元の変数(実引数)の値を変更出来ない</b>、関数呼び出しが遅い</li>
</ul>

<p>
(2) ポインタ渡し
</p>

<ul>
<li>メリット:　<b>関数の中で呼び出し元の変数(実引数)の値を変更出来る</b>、関数呼び出しが速い</li>
<li>デメリット:　ソースコードが見づらい、初学者が理解しづらい</li>
</ul>

<p>
(3) 参照渡し
</p>

<ul>
<li>メリット:　ソースコードがすっきりして見やすい、初学者が理解しやすい、関数の中で呼び出し元の変数(実引数)の値を変更出来る、関数呼び出しが速い</li>
<li>デメリット:　特に無し(※)</li>
</ul>

<p>
※ と私は思っているのですが、何かあったら教えて下さい
</p>

</div>

<p>
これらのメリット・デメリットのうち、特に
</p>

<div class="info">
<input type="checkbox"><b>各渡し方のメリット・デメリット(抜粋):</b>

<p>
「値渡しの」デメリット:　<b>関数の中で呼び出し元の変数(実引数)の値を変更出来ない</b>
</p>

<p>
「ポインタ渡し」のメリット:　<b>関数の中で呼び出し元の変数(実引数)の値を変更出来る</b>
</p>
</div>

<p>
の２つについて、これから実例を挙げながら詳しく解説して行きたいと思います。
</p>

<br>
<h3>
2. 値渡しの動作
</h3>

<p>
はじめに「値渡し」のデメリットである「どうして関数の中で呼び出し元の変数の値を変更出来ないのか」についてメモリ空間を使って説明して行きます。
</p>

<p>
まずは以下のソース1を実行して下さい。
</p>

<p>
実行すると HOGE 関数の中で a に 34 を代入しているはずなのに、最終的には 12 と表示されます。
<br>
つまり HOGE 関数を呼び出しても、呼び出し元( = main 関数) の変数 a の値は初期値の 12 から変わっていません。
</p>

<div class="info">
<input type="checkbox"><b>ソース 1: 値渡しの例</b>

<pre class="wrap">
#include &lt;stdio.h&gt;

void HOGE( short a )
{
   // ☆2

   a = 34;

   // ☆3
}

int main()
{
   short a = 12;

   // ☆1

   HOGE( a );

   // ☆4

   printf("a = %d\n", a ); // <b>12 と表示される</b>

   return 0;
}
</pre>

</div>

<p>
では動作解説します。
</p>

<p>
ソース 1 の main 関数から始まって ☆1 まで進んだとします。
<br>
☆1 時点におけるメモリ空間の状態は図1の様になります。
</p>

<p>
まだ HOGE 関数の中に入っていませんので、変数は「main 関数の a」のひとつしか定義されていません。
<br>
そしてその a には 12 が入っています。
</p>

<div class="info">
<input type="checkbox"><b>図1: ☆1 時点におけるメモリ空間の状態 </b>
<p>
※ 例なのでアドレスは適当です。
</p>
<img src="./img/page01-fig1.png" alt="">
</div>

<p>
このまま HOGE 関数の中の ☆2 までプログラムを進めてみます。
</p>

<p>
HOGE 関数の引数として「short a」が指定されていますので、
</p>

<p>
<b>HOGE 関数に入る直前に short 型の a がもうひとつ別に作られ、「main 関数の a 」の値が新しく作られた「 HOGE 関数の a 」に代入コピーされます。</b>
</p>

<p>
これが「値渡し」の動作で、その結果 ☆2 時点におけるメモリ空間の状態は図2の様になります。
</p>

<div class="info">
<input type="checkbox"><b>図2: ☆2 時点におけるメモリ空間の状態 </b>
<p>
※ 例なのでアドレスは適当です。
</p>
<img src="./img/page01-fig2.png" alt="">
</div>

<p>
そのまま ☆3 まで進みます。
<br>
☆3 時点におけるメモリ空間の状態は図3の様になります。
</p>

<p>
☆3 の直前の行で「HOGE 関数の a 」に 34 が代入されていますが、「main 関数の a 」の値はそのままであることに注目して下さい。
</p>

<div class="info">
<input type="checkbox"><b>図3: ☆3 時点におけるメモリ空間の状態 </b>
<p>
※ 例なのでアドレスは適当です。
</p>
<img src="./img/page01-fig3.png" alt="">
</div>

<p>
では HOGE 関数を抜けて main 関数に戻り、☆4 まで進みます。
<br>
</p>

<p>
HOGE 関数を抜けた瞬間に「HOGE 関数の a 」は消えて無くなりますので、よって ☆4 時点におけるメモリ空間の状態は図4の様になります。
<br>
この様に「main 関数の a 」の値は元の 12 のままです。
</p>

<div class="info">
<input type="checkbox"><b>図4: ☆4 時点におけるメモリ空間の状態 </b>
<p>
※ 例なのでアドレスは適当です。
</p>
<img src="./img/page01-fig1.png" alt="">
</div>

<p>
以上の説明から、関数の引数の渡し方として「値渡し」を使うと、関数の中から元の変数の値を変えることが出来ないことが理解できたと思います。
</p>

<br>
<h3>
3. ポインタ渡しの動作
</h3>

<p>
次は「ポインタ渡し」のメリットである「どうして関数の中で呼び出し元の変数の値を変更出来るのか」についてもメモリ空間を使って説明して行きます。
</p>

<p>
まずは以下のソース2を実行して下さい。
<br>
ソース1との違い(3箇所)はソース内のコメントに示しています。
</p>

<p>
実行すると最終的に 34 と表示されます。
<br>
つまり HOGE 関数を呼び出したら、呼び出し元( = main 関数) の変数 a の値が 34 に変わりました。
</p>

<div class="info">
<input type="checkbox"><b>ソース 2: ポインタ渡しの例</b>

<pre class="wrap">
#include &lt;stdio.h&gt;

void HOGE( short *pa ) // <b>← ソース1と違って * 付き</b>
{
   // ☆2

   *pa = 34; // <b>← ソース1と違って間接演算子付き</b>

   // ☆3
}

int main()
{
   short a = 12;

   // ☆1

   HOGE( &a ); // <b>← ソース1と違ってアドレス演算子付き</b>

   // ☆4

   printf("a = %d\n", a ); // <b>34 と表示される</b>

   return 0;
}
</pre>

</div>

<p>
では動作解説します。 
</p>

<p>
ソース 2 の main 関数から始まって ☆1 まで進んだとします。
<br>
☆1 時点におけるメモリ空間の状態は図5の様になります。
</p>

<p>
ここまでは値渡しの時の図1と同じ状態です。
<br>
つまり、まだ HOGE 関数の中に入っていませんので、変数は「main 関数の a」のひとつしか定義されていません。
<br>
そしてその a には 12 が入っています。
</p>

<div class="info">
<input type="checkbox"><b>図5: ☆1 時点におけるメモリ空間の状態 </b>
<p>
※ 例なのでアドレスは適当です。
</p>
<img src="./img/page01-fig1.png" alt="">
</div>

<p>
このまま HOGE 関数の中の ☆2 までプログラムを進めてみます。
</p>

<p>
HOGE 関数の引数としてポインタ変数「short *pa」が指定されており、 更に main 関数から HOGE 関数を呼び出す時に a の前にアドレス演算子 &amp; が付いていますので、
</p>

<p>
<b>HOGE 関数に入る直前に short 型のポインタ変数 pa が作られ、「main 関数の a 」のアドレスが「 HOGE 関数のポインタ変数 pa 」に代入されます。</b>
</p>

<p>
これが「ポインタ渡し」の動作で、その結果 ☆2 時点におけるメモリ空間の状態は図6の様になります。
</p>

<div class="info">
<input type="checkbox"><b>図6: ☆2 時点におけるメモリ空間の状態 </b>
<p>
※ 例なのでアドレスは適当です。
</p>
<img src="./img/page01-fig6.png" alt="">
</div>

<p>
そのまま ☆3 まで進みます。
</p>

<p>
☆3 の直前の行で間接演算子 * を使って「*pa」に 34 が代入されていますが
</p>

<p>
<b>*pa は「main 関数の a 」を参照している(矢印で指し示している)ので「main 関数の a 」に 34 が入ります。</b>
</p>

<p>
従って ☆3 時点におけるメモリ空間の状態は図 7 の様になります。
</p>

<div class="info">
<input type="checkbox"><b>図7: ☆3 時点におけるメモリ空間の状態 </b>
<p>
※ 例なのでアドレスは適当です。
</p>
<img src="./img/page01-fig7.png" alt="">
</div>

<p>
では HOGE 関数を抜けて main 関数に戻り、☆4 まで進みます。
<br>
</p>

<p>
HOGE 関数を抜けた瞬間に「HOGE 関数のポインタ変数 pa 」は消えて無くなりますので、よって ☆4 時点におけるメモリ空間の状態は図 8 の様になります。
<br>
「値渡し」の時と違って「main 関数の a 」の値が 34 になっていることに注目して下さい。
</p>

<div class="info">
<input type="checkbox"><b>図8: ☆4 時点におけるメモリ空間の状態 </b>
<p>
※ 例なのでアドレスは適当です。
</p>
<img src="./img/page01-fig8.png" alt="">
</div>

<p>
以上の説明から、関数の引数の渡し方として「ポインタ渡し」を使うと、関数の中から元の変数の値も変えることが出来ることが理解できたと思います。
</p>

</body>
</html>
