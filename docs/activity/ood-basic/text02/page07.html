<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
<link rel="stylesheet" href="../../../common.css">
<script src="../../../common.js"></script>
<title>7. 衝突判定処理</title>
</head>
<body>

<nav class="brcr">
<ol>
<li><a href="../">アクティビティ: オブジェクト指向開発入門</a></li>
<li>学習項目: [1] Unity2D の基本</li>
<li><script>GetTitle()</script></li>
</ol>
</nav>

<h2><script>GetTitle()</script></h2>

<p>
オブジェクト間の衝突判定は主に OnCollision〜系、OnTrigger〜系に分かれます。
<br>
複雑な仕組みなので順を追って説明していきます。
</p>

<h3>
(1) OnCollision〜系による衝突判定
</h3>

<p>
OnCollision〜系は基本的な衝突判定処理で、今回は色々あるメソッドのうち <b>OnCollisionEnter2D</b> を取り上げます。
<br>
OnCollisionEnter2D はあるオブジェクトとオブジェクトが衝突した瞬間に呼び出されるメソッドです。
</p>

<p>
さて A と B というオブジェクトがあってそれらの衝突判定処理をしたい時は、まず次の様にして〜Collider 2D コンポーネントをアタッチします。
</p>

<div class="info">
<input type="checkbox"><b>〜Collider 2D コンポーネントをアタッチする</b>
<div class="olradio"> 
<p>
<span class="olradio"><input type="radio" name="p1"></span> Hierarchy ウィンドウで対象のオブジェクトを選択する。 
<br>
<span class="olradio"><input type="radio" name="p1"></span> Inspector ウィンドウの Add Component ボタンを押してメニューを表示する。 
<br>
<span class="olradio"><input type="radio" name="p1"></span> Physics 2D → 〜Collider 2D を選択する。
</p>
<p>
※ 〜Collider には Box(四角形の判定領域)、Circle(円状の判定領域) など色々あります。
</p>
<p>
<span class="olradio"><input type="radio" name="p1"></span> Inspector ウィンドウの 〜Collider 2D の所にある Edit Collider ボタンを押すと衝突判定領域の調整が出来る。
</p>
</div>
</div>

<p>
するとこの時点で 〜Collider 2D をアタッチしたオブジェクト間に衝突が生じて重なる事が出来なくなります。
</p>

<p>
〜Collider 2D をアタッチしたら次は衝突判定を行いますが、A 又は B どちらかのスクリプトに対して以下の  OnCollisionEnter2D メソッドを追加するだけで出来ます。
</p>

<div class="info">
<input type="checkbox"><b>OnCollisionEnter2D</b>
<pre class="wrap">
void OnCollisionEnter2D( Collision2D collision )
{
     // 衝突判定処理
}
</pre>
</div>

<br>
<h3>
(2) レイヤーによる衝突設定
</h3>

<p>
A と B と C というオブジェクトがあり、A は B とは衝突したいけど C とは衝突したくないという時はレイヤー機能を使います。
</p>

<p>
そもそもの前提として各オブジェクトは必ずある階層(レイヤー)に属しています。
<br>
それで、異なるレイヤーにいるオブジェクト間は衝突させない様にすることが可能です(※)。
</p>

<p>
※ 建物の 1F にいる人と 4F にいる人は触れることが出来ないみたいなイメージです。
</p>

<p>
まずオブジェクトにレイヤーを設定する手順は以下のとおりです。
</p>

<div class="info">
<input type="checkbox"><b>オブジェクトにレイヤーを設定する</b>
<div class="olradio"> 
<p>
<span class="olradio"><input type="radio" name="p2"></span> Hierarchy ウィンドウ上でオブジェクトを選択してInspector ウィンドウを開く。デフォルトでは Layer プルダウンメニューに Default と書いてあることを確認する。
<br>
<span class="olradio"><input type="radio" name="p2"></span> (レイヤーを新規作成する場合) Layer プルダウンメニューをクリック → Add Layer を選択し、下の図の様に User Layer の空いている所に好きなレイヤー名を設定する。
</p>
<img src="./img/layer1.png">
<p>
<span class="olradio"><input type="radio" name="p2"></span>  Layer プルダウンメニューから適切なレイヤーを選択する。
</p>
</div>
</div>

<p>
これでオブジェクトにレイヤーを設定出来ましたが、このままだとまだ全てのオブジェクト間と衝突が起きますので、以下のようにして特定のレイヤーに属するオブジェクトと衝突出来ないようにします。
</p>

<div class="info">
<input type="checkbox"><b>レイヤー間の衝突設定をする</b>
<div class="olradio"> 
<p>
<span class="olradio"><input type="radio" name="p3"></span> Unity エディタの Edit メニュー → Project Settings → Physics2D を選択する。
<br>
<span class="olradio"><input type="radio" name="p3"></span> 以下の例のように Layer Collision Matrix の設定をする。チェックが付いているレイヤー間は衝突が起きる。
</p>
<img src="./img/layer2.png">
<br>
※ この例の場合は LayerA と Layer B 間はチェックが付いているので衝突するが、LayerA と Layer C 間はチェックが無いので衝突しない。
</div>
</div>

<br>
<h3>
(3) タグによる衝突オブジェクトの判定
</h3>

<p>
衝突したオブジェクトの種類によって処理を変えたい場合はタグ機能を使います。
</p>

<p>
まずオブジェクトにタグを設定する手順は以下のとおりです。
</p>

<div class="info">
<input type="checkbox"><b>オブジェクトにタグを設定する</b>
<div class="olradio"> 
<p>
<span class="olradio"><input type="radio" name="p2"></span> Hierarchy ウィンドウ上でオブジェクトを選択して Inspector ウィンドウを開く。デフォルトでは Tag プルダウンメニューに Untagged と書いてあることを確認する。
<br>
<span class="olradio"><input type="radio" name="p2"></span> (タグを新規作成する場合) Tag プルダウンメニューをクリック → Add Tags を選択し、Tags の + ボタンを押し、下の図の様に好きなタグ名を入れて Save で保存する。
</p>
<img src="./img/tag1.png">
<p>
<span class="olradio"><input type="radio" name="p2"></span>  Tag プルダウンメニューから適切なタグを選択する。
</p>
</div>
</div>

<p>
こうして設定したタグは衝突時に以下のようにして OnCollisionEnter2D 内で使用できます。
</p>

<div class="info">
<input type="checkbox"><b>OnCollisionEnter2D</b>
<pre class="wrap">
void OnCollisionEnter2D( Collision2D collision )
{
    if (collision.gameObject.tag == "TagA") {	

       // TagA がついたオブジェクトと衝突した時の処理

    }
    if (collision.gameObject.tag == "TagB") {	

       // TagB がついたオブジェクトと衝突した時の処理

    }
    // 以下同様

}
</pre>
</div>

<br>
<h3>
(4) OnTrigger〜系による衝突判定
</h3>

<p>
今まではオブジェクト間は衝突して重なる事が出来ない状況を考えていましたが、レーザー光線みたいに他のオブジェクトと重なって突き抜ける様なオブジェクトと衝突判定をしたい場合は OnTrigger〜系による衝突判定を行います。
</p>

<p>
今回は色々あるメソッドのうち <b>OnTriggerEnter2D</b> を取り上げます。
<br>
OnTriggerEnter2D はあるオブジェクトとオブジェクトが重なった瞬間に呼び出されるメソッドです。
</p>

<p>
さて A と B というオブジェクトがあって、A と B が重なられる様にし、かつ重なった時に衝突判定したい場合は次のようにしてどちらかのオブジェクトに対してトリガー設定をします(※)。
</p>

<p>
※ もちろん上で出てきたレイヤー機能を使っても重なられるように出来ますが衝突判定が出来ません。
</p>

<div class="info">
<input type="checkbox"><b>トリガー設定の方法</b>
<div class="olradio"> 
<p>
<span class="olradio"><input type="radio" name="p1"></span> Hierarchy ウィンドウで対象のオブジェクトを選択する。 
<br>
<span class="olradio"><input type="radio" name="p1"></span> Inspector ウィンドウの 〜Collider 2D の Is Trigger プロパティをチェックする。
</div>
</div>

<p>
するとこの時点でトリガー設定をしたオブジェクトは他のオブジェクトと重なることが可能になります。
</p>

<p>
ただし、今まで使ってきた OnCollisionEnter2D メソッドは呼び出されなくなりますので、代わりに次の OnTriggerEnter2D メソッドを使います。
<br>
もちろんタグを使って重なったオブジェクト種類の判定も出来ます。
</p>

<div class="info">
<input type="checkbox"><b>OnTriggerEnter2D</b>
<pre class="wrap">
void OnTriggerEnter2D( Collider2D collider ) // OnCollisionEnter2D と引数の型が異なることに注意
{
    if ( collider.tag == "TagA") {	

       // TagA がついたオブジェクトと重なった時の処理

    }
    if ( collider.tag == "TagB") {	

       // TagB がついたオブジェクトと重なった時の処理

    }
    // 以下同様

}
</pre>
</div>

<p>
なおトリガーよりもレイヤーが優先されますので、レイヤーで衝突出来ないように設定している場合はオブジェクトが重なっても OnTriggerEnter2D は呼び出されません。
</p>

<p>
ちなみに少し高度な話になりますが、親オブジェクトに Rigidbody 2D と 〜Collider 2D をアタッチし、子オブジェクトには 〜Collider 2D だけをアタッチした時、子オブジェクトの衝突イベントは親オブジェクトに送られます。
<br>
この仕様を応用すると親は非トリガー設定にしてレイヤーで衝突制御、子はトリガー設定ですり抜け可能とすることも可能になります。
<br>
つまり A と B はすり抜けられない、A と C はすり抜けられる、A と B が衝突したら OnCollision〜 で処理、A と C が重なったら OnTrigger〜 で処理、みたいな事が出来ます。
<br>
またジャンプ時の接地判定などにも使えます。
</p>

<br>
<script>PreNext(7,10)</script>
</body>
</html>
